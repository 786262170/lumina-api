# 如何获取微信授权码 (code)

## 重要说明

⚠️ **code 不能直接通过 API 获取！**

code 是微信 OAuth 2.0 授权流程中的临时授权码，必须通过用户授权才能获取。

---

## 方法一：使用授权 URL（推荐）

### 步骤 1：生成授权 URL

使用你的 AppID `wx68bd5e55d855bf4d`，生成授权 URL：

```
https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx68bd5e55d855bf4d&redirect_uri=YOUR_CALLBACK_URL&response_type=code&scope=snsapi_userinfo#wechat_redirect
```

**参数说明：**
- `appid`: 你的微信 AppID (`wx68bd5e55d855bf4d`)
- `redirect_uri`: 授权回调地址（需要 URL 编码）
- `scope`: 授权范围
  - `snsapi_base`: 静默授权，仅获取 openid
  - `snsapi_userinfo`: 需要用户确认，可获取用户信息（推荐）

### 步骤 2：替换回调地址

将 `YOUR_CALLBACK_URL` 替换为你的实际回调地址，例如：

```
https://yourdomain.com/auth/callback
```

**完整示例：**

```
https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx68bd5e55d855bf4d&redirect_uri=https%3A%2F%2Fyourdomain.com%2Fauth%2Fcallback&response_type=code&scope=snsapi_userinfo#wechat_redirect
```

### 步骤 3：在微信中打开授权 URL

1. **在微信内置浏览器中打开**（推荐）
   - 将授权 URL 发送到微信
   - 在微信中点击打开
   - 或使用微信扫码

2. **用户授权**
   - 用户点击"同意"授权
   - 微信会跳转到你的回调地址

### 步骤 4：从回调 URL 中提取 code

授权成功后，微信会跳转到：

```
https://yourdomain.com/auth/callback?code=081abc123def456&state=xxx
```

**提取 code：**

```javascript
// 前端代码
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code'); // 这就是你需要的 code

// 立即发送到后端
fetch('/v1/auth/wechat-login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ code })
});
```

---

## 方法二：使用测试工具

### 快速生成授权 URL

运行脚本：

```bash
cd /Users/an/code/ai/lumina-api
python3 scripts/get_wechat_code.py
```

脚本会：
1. 读取 `.env` 中的 AppID
2. 提示输入回调地址
3. 生成授权 URL

---

## 方法三：使用 Mock 模式（开发测试）

如果只是测试后端 API，可以使用 Mock 模式：

```env
# .env
WECHAT_MOCK_MODE=true
```

此时，可以使用任意 code 进行测试：

```bash
curl -X POST http://localhost:8000/v1/auth/wechat-login \
  -H 'Content-Type: application/json' \
  -d '{"code": "test_code_123"}'
```

后端会返回模拟的用户信息。

---

## 方法四：使用在线工具

### 1. 微信公众平台测试号

如果你有微信公众平台测试号：
- 访问：https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign
- 使用测试号的 AppID 和 AppSecret

### 2. 微信开发者工具

- 使用微信开发者工具
- 在工具中测试授权流程

---

## 注意事项

### 1. 回调地址必须配置

在微信开放平台/公众平台中，必须配置授权回调域名：

- **网页应用**：在"开发" → "接口权限" → "网页授权"中配置
- **移动应用**：在创建应用时配置

### 2. code 的特性

- ✅ **有效期**：5 分钟
- ✅ **一次性**：使用后立即失效
- ✅ **立即使用**：获取后立即发送到后端

### 3. 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| 40029 | code 无效 | code 已过期，重新获取 |
| 40163 | code 已被使用 | code 只能使用一次，重新授权 |
| redirect_uri 不匹配 | 回调地址未配置 | 在微信平台配置回调域名 |

---

## 完整示例

### 1. 生成授权 URL

```python
import urllib.parse

app_id = 'wx68bd5e55d855bf4d'
redirect_uri = 'https://yourdomain.com/auth/callback'
scope = 'snsapi_userinfo'

params = {
    'appid': app_id,
    'redirect_uri': redirect_uri,
    'response_type': 'code',
    'scope': scope
}

query_string = urllib.parse.urlencode(params)
auth_url = f'https://open.weixin.qq.com/connect/oauth2/authorize?{query_string}#wechat_redirect'

print(auth_url)
```

### 2. 前端获取 code

```javascript
// 方式 1：网页应用
const code = new URLSearchParams(window.location.search).get('code');

// 方式 2：移动应用（使用 SDK）
const loginResult = await wechat.login({ appId: 'wx68bd5e55d855bf4d' });
const code = loginResult.code;
```

### 3. 发送到后端

```bash
curl -X POST http://localhost:8000/v1/auth/wechat-login \
  -H 'Content-Type: application/json' \
  -d '{"code": "081abc123def456"}'
```

---

## 快速测试

如果你想快速测试后端 API，可以使用 Mock 模式：

```bash
# 1. 设置 Mock 模式
echo "WECHAT_MOCK_MODE=true" >> .env

# 2. 重启服务

# 3. 使用任意 code 测试
curl -X POST http://localhost:8000/v1/auth/wechat-login \
  -H 'Content-Type: application/json' \
  -d '{"code": "test_123"}'
```

---

## 总结

**code 获取流程：**

1. 生成授权 URL（使用 AppID）
2. 在微信中打开授权 URL
3. 用户授权
4. 微信回调并返回 code
5. 从回调 URL 中提取 code
6. 立即发送到后端 API

**重要提示：**
- code 不能直接通过 API 获取
- 必须通过用户授权流程
- code 有效期 5 分钟
- code 只能使用一次

