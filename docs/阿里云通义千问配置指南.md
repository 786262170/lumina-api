# 阿里云通义千问 VL 配置指南

本文档说明如何配置阿里云通义千问 VL（Qwen-VL）多模态大模型用于图片理解服务。

## 一、申请 API Key

### 1.1 登录阿里云控制台

1. 访问 [阿里云控制台](https://home.console.aliyun.com/)
2. 登录您的阿里云账号

### 1.2 开通 DashScope 服务

1. 进入 [DashScope 控制台](https://dashscope.console.aliyun.com/)
2. 如果没有开通，点击"立即开通"
3. 完成实名认证（如需要）

### 1.3 创建 API Key

1. 在 DashScope 控制台，点击左侧菜单"API-KEY 管理"
2. 点击"创建新的 API Key"
3. 输入 API Key 名称（例如：`lumina-api-key`）
4. 复制生成的 API Key（格式：`sk-xxxxxxxxxxxxx`）
   - ⚠️ **重要**：API Key 只显示一次，请妥善保存

### 1.4 充值账户（如需要）

1. 在 DashScope 控制台，点击"费用中心"
2. 查看当前余额
3. 如需充值，点击"充值"按钮

## 二、配置应用

### 2.1 更新 .env 文件

在项目根目录的 `.env` 文件中添加或修改以下配置：

```env
# 阿里云通义千问 VL 配置
LLM_PROVIDER=aliyun
LLM_MODEL=qwen-vl-plus
LLM_API_KEY=sk-your-dashscope-api-key-here
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_MOCK_MODE=false
```

### 2.2 配置说明

- **LLM_PROVIDER**: 设置为 `aliyun`、`dashscope` 或 `qwen`（三者等效）
- **LLM_MODEL**: 模型名称，可选：
  - `qwen-vl-plus` - 推荐，性能最强
  - `qwen-vl-max` - 最新版本，性能更强
  - `qwen-vl` - 基础版，性价比高
- **LLM_API_KEY**: 您的 DashScope API Key（格式：`sk-xxxxxxxxxxxxx`）
- **LLM_BASE_URL**: API 端点（通常使用默认值即可）
- **LLM_MOCK_MODE**: 设置为 `false` 以使用真实模型

### 2.3 快速配置脚本

您也可以使用以下命令快速更新配置：

```bash
# 设置 provider
sed -i.bak 's/^LLM_PROVIDER=.*/LLM_PROVIDER=aliyun/' .env

# 设置模型
sed -i.bak 's/^LLM_MODEL=.*/LLM_MODEL=qwen-vl-plus/' .env

# 设置 API Key（请替换为您的实际 API Key）
sed -i.bak 's/^LLM_API_KEY=.*/LLM_API_KEY=sk-your-api-key/' .env

# 关闭 mock 模式
sed -i.bak 's/^LLM_MOCK_MODE=.*/LLM_MOCK_MODE=false/' .env
```

## 三、模型选择

### 3.1 可用模型对比

| 模型 | 性能 | 价格 | 适用场景 |
|------|------|------|----------|
| `qwen-vl-plus` | ⭐⭐⭐⭐⭐ | 中等 | 推荐，适合大多数场景 |
| `qwen-vl-max` | ⭐⭐⭐⭐⭐ | 较高 | 最新版本，性能最强 |
| `qwen-vl` | ⭐⭐⭐⭐ | 较低 | 基础版，性价比高 |

### 3.2 模型特点

- **qwen-vl-plus**：
  - 多模态理解能力强
  - 中文场景表现优秀
  - 支持图片分析、描述生成、标签提取
  - 推荐用于生产环境

- **qwen-vl-max**：
  - 最新版本，性能最强
  - 适合复杂图片理解任务
  - 价格相对较高

- **qwen-vl**：
  - 基础版本
  - 适合简单场景或测试
  - 价格较低

## 四、测试配置

### 4.1 重启应用

配置更新后，重启应用以使配置生效：

```bash
# 如果使用 uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 4.2 测试图片分析

使用 API 测试图片分析功能：

```bash
# 测试图片分析接口
curl -X POST "http://localhost:8000/v1/images/analyze" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "imageUrl": "https://example.com/image.jpg",
    "prompt": "请分析这张图片"
  }'
```

### 4.3 检查日志

查看应用日志，确认模型调用成功：

```bash
# 查看日志
tail -f logs/app.log

# 或查看控制台输出
# 应该看到类似以下日志：
# INFO - LiteLLM image analysis completed for ... using dashscope/qwen-vl-plus
```

## 五、价格参考

### 5.1 计费方式

- 按 Token 计费（输入 + 输出）
- 图片会转换为 base64，占用一定 Token

### 5.2 价格（参考，以官方为准）

- **qwen-vl-plus**: 约 ¥0.012/1K tokens（输入），¥0.012/1K tokens（输出）
- **qwen-vl-max**: 约 ¥0.015/1K tokens（输入），¥0.015/1K tokens（输出）
- **qwen-vl**: 约 ¥0.008/1K tokens（输入），¥0.008/1K tokens（输出）

### 5.3 成本优化建议

1. 合理设置 `max_tokens` 参数
2. 对于简单任务，使用 `qwen-vl` 基础版
3. 批量处理时考虑使用异步处理
4. 启用缓存机制（如需要）

## 六、常见问题

### 6.1 API Key 无效

**问题**：返回 `Invalid API Key` 错误

**解决方案**：
- 检查 API Key 是否正确复制（包括 `sk-` 前缀）
- 确认 API Key 是否已激活
- 检查账户余额是否充足

### 6.2 模型调用失败

**问题**：返回模型调用错误

**解决方案**：
- 检查 `LLM_PROVIDER` 和 `LLM_MODEL` 配置是否正确
- 确认模型名称格式：`qwen-vl-plus`（不需要 `dashscope/` 前缀，代码会自动添加）
- 查看应用日志获取详细错误信息

### 6.3 图片无法分析

**问题**：图片分析返回空结果

**解决方案**：
- 确认图片 URL 可访问
- 检查图片格式是否支持（JPEG、PNG、WebP）
- 确认图片大小不超过限制（通常 20MB）
- 查看日志确认图片下载是否成功

### 6.4 响应速度慢

**问题**：图片分析响应时间较长

**解决方案**：
- 使用 `qwen-vl` 基础版（速度更快）
- 优化图片大小（压缩后再上传）
- 考虑使用异步处理
- 检查网络连接

## 七、高级配置

### 7.1 自定义 Base URL

如果需要使用自定义端点：

```env
LLM_BASE_URL=https://your-custom-endpoint.com/v1
```

### 7.2 环境变量配置

也可以通过环境变量配置（优先级高于 .env）：

```bash
export LLM_PROVIDER=aliyun
export LLM_MODEL=qwen-vl-plus
export LLM_API_KEY=sk-your-api-key
export LLM_MOCK_MODE=false
```

### 7.3 多模型切换

如果需要根据不同场景使用不同模型，可以在代码中动态切换：

```python
from app.config import settings

# 临时切换模型
settings.llm_model = "qwen-vl"  # 切换到基础版
```

## 八、参考链接

- [阿里云 DashScope 控制台](https://dashscope.console.aliyun.com/)
- [通义千问 VL 文档](https://help.aliyun.com/zh/model-studio/developer-reference/api-details-9)
- [LiteLLM 文档](https://docs.litellm.ai/)
- [价格说明](https://help.aliyun.com/zh/model-studio/product-overview/billing-overview)

## 九、配置检查清单

- [ ] 已开通 DashScope 服务
- [ ] 已创建 API Key 并妥善保存
- [ ] 已更新 `.env` 文件配置
- [ ] `LLM_PROVIDER` 设置为 `aliyun`
- [ ] `LLM_MODEL` 设置为 `qwen-vl-plus`（或其他模型）
- [ ] `LLM_API_KEY` 已正确配置
- [ ] `LLM_MOCK_MODE` 设置为 `false`
- [ ] 已重启应用
- [ ] 已测试图片分析功能
- [ ] 已检查日志确认调用成功

