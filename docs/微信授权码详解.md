# 微信登录中的 `code` 参数详解

## 什么是 `code`？

`code` 是**微信 OAuth 授权码**，是微信 OAuth 2.0 授权流程中的关键参数。

### 基本特性

- ✅ **临时授权码**：由微信服务器生成
- ✅ **一次性使用**：使用后立即失效
- ✅ **短有效期**：通常只有 **5 分钟**有效期
- ✅ **不可重复使用**：每个 code 只能使用一次
- ✅ **随机字符串**：格式类似 `081abc123def456` 或 `0a1b2c3d4e5f6g7h`

---

## 完整授权流程

### 第一步：前端发起授权请求

用户在前端（网页/移动应用）点击"微信登录"按钮，前端需要：

#### 网页应用（Web）

```javascript
// 1. 构建授权 URL
const appId = 'wx68bd5e55d855bf4d';
const redirectUri = encodeURIComponent('https://yourdomain.com/auth/callback');
const scope = 'snsapi_userinfo'; // 或 'snsapi_base'
const state = 'random_string_for_csrf_protection';

const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}&state=${state}#wechat_redirect`;

// 2. 跳转到授权页面
window.location.href = authUrl;
```

#### 移动应用（鸿蒙/iOS/Android）

```typescript
// 使用微信 SDK
import wechat from '@ohos/wechat';

async function wechatLogin() {
  // 调用微信登录 SDK
  const loginResult = await wechat.login({
    appId: 'wx68bd5e55d855bf4d',
    scope: 'snsapi_userinfo'
  });
  
  // 获取 code
  const code = loginResult.code; // 这就是我们需要的 code
}
```

### 第二步：用户授权

1. 用户被跳转到微信授权页面
2. 用户点击"同意"授权
3. 微信服务器生成 `code` 和 `state`（如果提供了）

### 第三步：微信回调并返回 code

#### 网页应用

微信会重定向到 `redirect_uri`，并带上 `code` 参数：

```
https://yourdomain.com/auth/callback?code=081abc123def456&state=random_string
```

前端需要从 URL 中提取 `code`：

```javascript
// 从 URL 参数中获取 code
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get('code');
const state = urlParams.get('state');

// 验证 state（防止 CSRF 攻击）
if (state !== expectedState) {
  console.error('State mismatch');
  return;
}
```

#### 移动应用

微信 SDK 直接返回 `code`：

```typescript
const code = loginResult.code; // 直接获取
```

### 第四步：前端将 code 发送到后端

```javascript
// 前端代码
const response = await fetch('https://your-api.com/v1/auth/wechat-login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ 
    code: code  // 将 code 发送到后端
  })
});

const data = await response.json();
// data.token 是后端返回的 JWT token
```

### 第五步：后端使用 code 换取用户信息

后端收到 `code` 后，执行以下流程（见 `app/utils/wechat.py`）：

```python
# 1. 使用 code 换取 access_token 和 openid
token_url = "https://api.weixin.qq.com/sns/oauth2/access_token"
token_params = {
    "appid": "wx68bd5e55d855bf4d",
    "secret": "8f2253ff64263ad64fe0633a935d49ec",
    "code": code,  # 使用前端传来的 code
    "grant_type": "authorization_code"
}

# 2. 微信返回 access_token 和 openid
response = requests.get(token_url, params=token_params)
# 返回: {
#   "access_token": "ACCESS_TOKEN",
#   "expires_in": 7200,
#   "refresh_token": "REFRESH_TOKEN",
#   "openid": "OPENID",
#   "scope": "SCOPE",
#   "unionid": "UNIONID"  // 如果有关联
# }

# 3. 使用 access_token 获取用户信息
user_info_url = "https://api.weixin.qq.com/sns/userinfo"
user_params = {
    "access_token": access_token,
    "openid": openid,
    "lang": "zh_CN"
}
# 返回用户昵称、头像等信息
```

---

## code 的生命周期

```
用户点击"微信登录"
    ↓
前端跳转到微信授权页面
    ↓
用户同意授权
    ↓
微信生成 code（有效期 5 分钟）
    ↓
微信回调前端，返回 code
    ↓
前端立即将 code 发送到后端
    ↓
后端使用 code 换取 access_token
    ↓
code 立即失效（一次性使用）
    ↓
后端使用 access_token 获取用户信息
    ↓
后端返回 JWT token 给前端
```

---

## 重要注意事项

### 1. code 必须立即使用

```javascript
// ❌ 错误：不要存储 code
localStorage.setItem('wechat_code', code); // 不要这样做！

// ✅ 正确：立即发送到后端
const response = await fetch('/v1/auth/wechat-login', {
  method: 'POST',
  body: JSON.stringify({ code })
});
```

### 2. code 只能使用一次

```python
# ❌ 错误：重复使用同一个 code
code = "081abc123def456"
get_user_info(code)  # 第一次：成功
get_user_info(code)  # 第二次：失败！code 已失效

# ✅ 正确：每个 code 只使用一次
code = get_code_from_frontend()
user_info = get_user_info(code)  # 使用后立即失效
```

### 3. code 有效期很短

- **有效期**：通常 5 分钟
- **建议**：前端获取 code 后，**立即**（1 秒内）发送到后端
- **不要**：将 code 存储在本地，稍后再使用

### 4. 防止 CSRF 攻击

```javascript
// 生成随机 state
const state = generateRandomString();

// 在授权 URL 中包含 state
const authUrl = `...&state=${state}...`;

// 回调时验证 state
const returnedState = urlParams.get('state');
if (returnedState !== state) {
  // 可能是 CSRF 攻击，拒绝请求
  return;
}
```

---

## 不同场景下的 code 获取方式

### 场景 1：网页应用（在微信内置浏览器中）

```javascript
// 1. 构建授权 URL
const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=snsapi_userinfo&state=${state}#wechat_redirect`;

// 2. 跳转
window.location.href = authUrl;

// 3. 在回调页面获取 code
const code = new URLSearchParams(window.location.search).get('code');
```

### 场景 2：网页应用（在普通浏览器中）

```javascript
// 使用二维码方式
// 1. 后端生成二维码（包含授权 URL）
// 2. 用户用微信扫码
// 3. 微信回调后端，后端通知前端
// 4. 前端轮询后端获取 code
```

### 场景 3：移动应用（鸿蒙/iOS/Android）

```typescript
// 使用微信 SDK
const loginResult = await wechat.login({
  appId: 'wx68bd5e55d855bf4d',
  scope: 'snsapi_userinfo'
});

const code = loginResult.code; // 直接获取
```

### 场景 4：小程序

```javascript
// 小程序内登录
wx.login({
  success: (res) => {
    const code = res.code; // 获取 code
    // 发送到后端
  }
});
```

---

## 错误处理

### 常见错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 40029 | code 无效 | code 已过期或已使用，需要重新获取 |
| 40163 | code 已被使用 | code 只能使用一次，需要重新授权 |
| 40125 | secret 错误 | 检查 AppSecret 是否正确 |
| 40013 | 无效的 AppID | 检查 AppID 是否正确 |

### 后端错误处理

```python
# app/utils/wechat.py
token_response = await client.get(token_url, params=token_params)
token_data = token_response.json()

if "errcode" in token_data:
    error_code = token_data.get("errcode")
    if error_code == 40029:
        # code 无效，需要前端重新获取
        return None
    elif error_code == 40163:
        # code 已被使用
        return None
    # 其他错误...
    return None
```

---

## 测试 code

### Mock 模式

在开发阶段，可以使用 Mock 模式：

```env
# .env
WECHAT_MOCK_MODE=true
```

此时，后端会接受任何 code，并返回模拟的用户信息：

```python
# app/utils/wechat.py
if settings.wechat_mock_mode:
    return {
        "openid": f"mock_openid_{code}",
        "nickname": "微信用户",
        "headimgurl": "https://cdn.lumina.ai/default_avatar.jpg"
    }
```

### 真实测试

1. 设置 `WECHAT_MOCK_MODE=false`
2. 在前端获取真实的 code
3. 发送到后端测试

---

## 总结

**`code` 是什么？**

- 微信 OAuth 授权码
- 由微信服务器生成
- 有效期 5 分钟
- 只能使用一次
- 用于换取 access_token 和 openid

**完整流程：**

```
前端 → 微信授权 → 获取 code → 发送到后端 → 后端换取 token → 获取用户信息 → 返回 JWT
```

**关键点：**

1. ✅ code 必须立即使用，不要存储
2. ✅ code 只能使用一次
3. ✅ code 有效期很短（5 分钟）
4. ✅ 前端获取 code 后立即发送到后端
5. ✅ 后端使用 code 换取 access_token，然后获取用户信息

---

## 相关文档

- [微信网页授权文档](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)
- [移动应用微信登录文档](https://developers.weixin.qq.com/doc/oplatform/en/Mobile_App/WeChat_Login/Development_Guide.html)
- [OAuth 2.0 标准](https://oauth.net/2/)

