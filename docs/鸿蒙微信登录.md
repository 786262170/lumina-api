# 鸿蒙移动端应用微信登录实现指南

## 重要说明

⚠️ **小程序和移动应用的 AppID/AppSecret 是不同的！**

- **小程序**：用于微信小程序内使用
- **移动应用**：用于 iOS/Android/鸿蒙等原生移动应用

如果你要在鸿蒙移动端应用中使用微信登录，需要：

1. **在微信开放平台创建移动应用**（不是小程序）
2. **获取移动应用的 AppID 和 AppSecret**
3. **使用移动应用的授权流程**

---

## 第一步：在微信开放平台创建移动应用

### 1. 注册/登录微信开放平台

- 访问：https://open.weixin.qq.com/
- **个人开发者**：可以注册个人账号，但功能受限
- **企业开发者**：需要企业资质，功能完整（推荐）

### 个人开发者申请方式

**重要**：微信开放平台对个人开发者有限制，但可以通过以下方式申请：

#### 方式一：使用个人身份注册（功能受限）

1. **注册个人账号**
   - 访问：https://open.weixin.qq.com/
   - 点击"注册" → 选择"个人开发者"
   - 填写个人信息（身份证、手机号等）
   - 完成实名认证

2. **创建移动应用**
   - 登录后进入"管理中心"
   - 点击"创建移动应用"
   - **注意**：个人开发者可能无法创建某些类型的应用，或需要额外审核

3. **限制说明**
   - 个人开发者创建的应用可能需要更严格的审核
   - 某些高级功能可能不可用
   - 建议查看最新的开放平台政策

#### 方式二：使用个体工商户（推荐）

如果你有营业执照（个体工商户也可以），可以：

1. **注册企业账号**
   - 使用个体工商户营业执照注册
   - 选择"企业开发者"
   - 功能更完整，审核更容易通过

2. **申请个体工商户**
   - 如果没有营业执照，可以到当地工商局申请
   - 个体工商户注册相对简单
   - 费用较低（部分地区免费）

#### 方式三：使用小程序 AppID（临时方案）

**注意**：这不是标准做法，但可以作为临时测试方案：

1. **使用小程序的 AppID**
   - 小程序的 AppID 和 AppSecret 可以在移动应用中临时使用
   - 但这不是官方推荐的方式
   - 可能在某些场景下无法正常工作

2. **配置方式**
   ```env
   # 临时使用小程序的 AppID（不推荐生产环境）
   WECHAT_APP_ID=wx68bd5e55d855bf4d
   WECHAT_APP_SECRET=8f2253ff64263ad64fe0633a935d49ec
   WECHAT_MOCK_MODE=false
   ```

3. **限制**
   - 小程序和移动应用的授权流程略有不同
   - 可能无法获取 UnionID
   - 建议尽快申请正式的移动应用

### 2. 创建移动应用

1. 进入"管理中心"
2. 点击"创建移动应用"
3. 填写应用信息：
   - **应用名称**：你的应用名称
   - **应用简介**：应用描述
   - **应用图标**：上传应用图标（512x512px）
   - **应用官网**：应用官网地址
   - **应用平台**：选择"鸿蒙"（HarmonyOS）
   - **Bundle ID/Package Name**：鸿蒙应用的包名
   - **应用签名**：鸿蒙应用的签名信息

### 3. 提交审核

- 填写完整信息后提交审核
- 审核时间：1-7 个工作日
- 审核通过后，获得移动应用的 **AppID** 和 **AppSecret**

### 4. 获取凭证

- 在"管理中心" -> "移动应用"中
- 找到你的应用，查看 **AppID** 和 **AppSecret**
- AppSecret 需要点击"查看"并验证身份后显示

---

## 第二步：鸿蒙应用端实现

### 1. 集成微信 SDK

在鸿蒙应用中集成微信 SDK：

```typescript
// 在 module.json5 中添加依赖
{
  "dependencies": [
    {
      "bundleName": "com.tencent.mm",
      "moduleName": "entry"
    }
  ]
}
```

### 2. 调用微信登录

```typescript
// 示例代码（ArkTS）
import wechat from '@ohos/wechat';

async function wechatLogin() {
  try {
    // 1. 调用微信登录
    const loginResult = await wechat.login({
      appId: 'wx68bd5e55d855bf4d', // 移动应用的 AppID
      scope: 'snsapi_userinfo' // 或 'snsapi_base'
    });
    
    // 2. 获取 code
    const code = loginResult.code;
    
    // 3. 将 code 发送到后端
    const response = await fetch('https://your-api.com/v1/auth/wechat-login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ code })
    });
    
    const data = await response.json();
    
    // 4. 保存 token
    if (data.token) {
      // 保存到本地存储
      Preferences.put('access_token', data.token);
    }
  } catch (error) {
    console.error('微信登录失败:', error);
  }
}
```

### 3. 获取用户信息（可选）

如果需要获取用户昵称、头像等信息：

```typescript
// 在登录成功后，可以获取用户信息
const userInfo = await wechat.getUserInfo({
  withCredentials: true
});

// 将用户信息也发送到后端更新
```

---

## 第三步：后端配置

### 1. 更新 .env 文件

```env
# 移动应用的 AppID 和 AppSecret（不是小程序的）
WECHAT_APP_ID=wx68bd5e55d855bf4d
WECHAT_APP_SECRET=your_mobile_app_secret_here
WECHAT_MOCK_MODE=false

# 如果需要区分小程序和移动应用，可以添加：
WECHAT_MOBILE_APP_ID=wx68bd5e55d855bf4d
WECHAT_MOBILE_APP_SECRET=your_mobile_app_secret_here
```

### 2. 后端代码已支持

当前的后端代码（`app/utils/wechat.py`）已经支持移动应用的授权流程：

- 使用 `sns/oauth2/access_token` 接口（移动应用和小程序通用）
- 使用 `sns/userinfo` 接口获取用户信息

**注意**：移动应用和小程序使用相同的 OAuth 接口，但 AppID/AppSecret 必须匹配对应的应用类型。

---

## 移动应用 vs 小程序的区别

| 特性 | 移动应用 | 小程序 |
|------|---------|--------|
| 平台 | iOS/Android/鸿蒙 | 微信小程序 |
| 申请位置 | 微信开放平台 | 微信公众平台 |
| AppID 格式 | 相同 | 相同 |
| AppSecret | 不同 | 不同 |
| 授权流程 | 相同 | 相同 |
| 使用场景 | 原生应用 | 微信内使用 |

---

## 常见问题

### Q1: 可以用小程序的 AppID 在移动应用中使用吗？

**技术上可以，但不推荐**。小程序和移动应用使用相同的 OAuth 接口，但：
- **小程序**：在微信公众平台申请，主要用于微信内使用
- **移动应用**：在微信开放平台申请，用于原生应用
- **临时方案**：可以使用小程序的 AppID 进行测试，但生产环境建议使用移动应用的 AppID
- **区别**：移动应用可以获取 UnionID，小程序在某些场景下可能无法获取

### Q2: 一个 AppID 可以同时用于多个平台吗？

**可以**。在微信开放平台创建移动应用时，可以添加多个平台（iOS、Android、鸿蒙），它们共享同一个 AppID 和 AppSecret。

### Q3: 鸿蒙应用需要特殊配置吗？

**需要**。在创建移动应用时，需要：
- 选择"鸿蒙"平台
- 填写鸿蒙应用的包名（Bundle ID）
- 提供应用签名信息

### Q4: 如何测试？

1. **开发环境**：使用 `WECHAT_MOCK_MODE=true` 进行测试
2. **测试环境**：使用真实的 AppID/AppSecret，但需要在微信开放平台配置测试包名
3. **生产环境**：使用审核通过的应用配置

---

## 配置检查清单

- [ ] 在微信开放平台创建移动应用（不是小程序）
- [ ] 选择"鸿蒙"平台
- [ ] 填写正确的包名和签名
- [ ] 提交审核并等待通过
- [ ] 获取移动应用的 AppID 和 AppSecret
- [ ] 在 `.env` 文件中配置正确的凭证
- [ ] 设置 `WECHAT_MOCK_MODE=false`
- [ ] 在鸿蒙应用中集成微信 SDK
- [ ] 测试登录流程

---

## 相关文档

- [微信开放平台](https://open.weixin.qq.com/)
- [移动应用微信登录文档](https://developers.weixin.qq.com/doc/oplatform/en/Mobile_App/WeChat_Login/Development_Guide.html)
- [鸿蒙应用开发文档](https://developer.harmonyos.com/)

---

## 当前配置状态

你提供的 AppID `wx68bd5e55d855bf4d` 是**小程序的 AppID**。

如果要在鸿蒙移动端应用中使用，需要：
1. 在微信开放平台创建移动应用
2. 获取移动应用的 AppID 和 AppSecret
3. 更新 `.env` 文件中的配置

**建议**：同时申请小程序和移动应用，这样可以：
- 小程序：用于微信内使用
- 移动应用：用于鸿蒙/iOS/Android 原生应用

