# 微信 AppID 和 AppSecret 申请指南

本项目使用微信 OAuth 登录功能，需要申请微信的 AppID 和 AppSecret。根据你的应用类型，可以选择以下两种方式：

## 方式一：微信公众号平台（推荐用于网页应用）

### 适用场景
- 网页应用（Web）
- 需要在微信内置浏览器中使用
- 需要获取用户基本信息

### 申请步骤

1. **注册微信公众号**
   - 访问：https://mp.weixin.qq.com/
   - 点击"立即注册"
   - 选择账号类型：
     - **订阅号**：个人可申请，功能较少
     - **服务号**：企业可申请，功能完整（推荐）
     - **企业号**：企业内部使用

2. **完成注册和认证**
   - 填写基本信息（邮箱、密码等）
   - 选择账号类型
   - 完成邮箱验证
   - 信息登记（需要营业执照等，企业号需要）
   - 微信认证（可选，但建议完成，功能更完整）

3. **获取 AppID 和 AppSecret**
   - 登录微信公众平台：https://mp.weixin.qq.com/
   - 进入"开发" -> "基本配置"
   - 找到"开发者ID(AppID)"和"开发者密码(AppSecret)"
   - 如果 AppSecret 未设置，点击"生成"按钮生成
   - **重要**：AppSecret 只显示一次，请妥善保存

4. **配置授权回调域名**
   - 在"开发" -> "接口权限" -> "网页授权"中
   - 点击"修改"，设置授权回调域名
   - 例如：`yourdomain.com`（不需要加 `http://` 或 `https://`）
   - 注意：只能设置一个主域名，子域名会自动包含

### 配置示例

```env
# .env 文件
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=your_app_secret_here
WECHAT_MOCK_MODE=false
```

---

## 方式二：微信开放平台（推荐用于移动应用）

### 适用场景
- 移动应用（iOS/Android）
- 需要跨平台统一用户身份（UnionID）
- 需要微信支付功能

### 申请步骤

1. **注册微信开放平台账号**
   - 访问：https://open.weixin.qq.com/
   - 点击"网站接入"或"移动应用"
   - 使用企业账号注册（个人无法注册）

2. **创建应用**
   - 登录后，进入"管理中心"
   - 点击"创建网站应用"或"创建移动应用"
   - 填写应用信息：
     - 应用名称
     - 应用简介
     - 应用图标
     - 应用官网
     - 授权回调域名

3. **提交审核**
   - 填写完整信息后提交审核
   - 审核时间：1-7 个工作日
   - 审核通过后，获得 AppID 和 AppSecret

4. **获取 AppID 和 AppSecret**
   - 在"管理中心" -> "网站应用"或"移动应用"中
   - 找到你的应用，查看"AppID"和"AppSecret"
   - AppSecret 需要点击"查看"并验证身份后显示

### 配置示例

```env
# .env 文件
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=your_app_secret_here
WECHAT_MOCK_MODE=false
```

---

## 前端配置

### 获取授权码（前端需要实现）

1. **构建授权 URL**
   ```javascript
   const appId = 'wx1234567890abcdef';
   const redirectUri = encodeURIComponent('https://yourdomain.com/auth/callback');
   const scope = 'snsapi_userinfo'; // 或 snsapi_base（仅获取 openid）
   const state = 'random_string'; // 用于防止 CSRF 攻击
   
   const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}&state=${state}#wechat_redirect`;
   ```

2. **用户授权后获取 code**
   - 用户点击授权链接
   - 微信跳转到 `redirect_uri?code=xxx&state=xxx`
   - 前端获取 `code` 参数

3. **发送 code 到后端**
   ```javascript
   // 前端代码示例
   const code = new URLSearchParams(window.location.search).get('code');
   const response = await fetch('/v1/auth/wechat-login', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({ code })
   });
   ```

---

## 注意事项

### 1. 域名配置
- 授权回调域名必须与实际使用的域名一致
- 支持子域名（如配置 `example.com`，`www.example.com` 和 `api.example.com` 都可以使用）
- 域名需要备案（国内服务器）

### 2. 测试环境
- 开发阶段可以使用 `WECHAT_MOCK_MODE=true` 进行测试
- 生产环境必须设置 `WECHAT_MOCK_MODE=false` 并使用真实的 AppID 和 AppSecret

### 3. 安全建议
- **不要**将 AppSecret 提交到代码仓库
- 使用环境变量或密钥管理服务存储敏感信息
- 定期更换 AppSecret（在微信公众平台重新生成）

### 4. 权限说明
- `snsapi_base`：静默授权，仅获取 openid，用户无感知
- `snsapi_userinfo`：需要用户确认，可获取用户昵称、头像等信息

### 5. 常见问题

**Q: AppSecret 忘记了怎么办？**
A: 在微信公众平台重新生成，旧密钥立即失效。

**Q: 授权回调域名可以修改吗？**
A: 可以，但有次数限制，建议谨慎修改。

**Q: 个人可以申请吗？**
A: 订阅号可以，但功能受限。服务号和开放平台需要企业资质。

**Q: 审核不通过怎么办？**
A: 检查应用信息是否完整，是否符合微信规范，联系客服咨询。

---

## 验证配置

配置完成后，可以通过以下方式验证：

1. **检查环境变量**
   ```bash
   # 确保 .env 文件中有正确的配置
   cat .env | grep WECHAT
   ```

2. **测试登录接口**
   ```bash
   # 使用真实的 code 测试（需要从微信授权流程获取）
   curl -X POST http://localhost:8000/v1/auth/wechat-login \
     -H "Content-Type: application/json" \
     -d '{"code": "test_code_from_wechat"}'
   ```

3. **查看日志**
   - 如果配置错误，会在日志中看到相关错误信息
   - 检查 `app/utils/wechat.py` 中的错误处理

---

## 相关文档

- [微信公众平台](https://mp.weixin.qq.com/)
- [微信开放平台](https://open.weixin.qq.com/)
- [网页授权文档](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)
- [微信开放平台文档](https://developers.weixin.qq.com/doc/oplatform/en/Website_App/WeChat_Login/Wechat_Login.html)

---

## 快速开始（开发环境）

如果只是开发测试，可以暂时使用 Mock 模式：

```env
# .env 文件
WECHAT_MOCK_MODE=true
WECHAT_APP_ID=
WECHAT_APP_SECRET=
```

这样可以在没有真实 AppID 的情况下测试登录流程。

