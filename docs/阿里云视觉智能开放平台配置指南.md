# 阿里云视觉智能开放平台配置指南

本文档说明如何配置阿里云视觉智能开放平台用于图像处理（抠图、背景替换、打光等）。

## 一、服务介绍

阿里云视觉智能开放平台（VIAPI）提供以下图像处理能力：

1. **图像分割（抠图）** - 必须开通
   - 通用图像分割
   - 人像分割
   - 商品分割
   - 用于：抠图、背景替换

2. **图像生产** - 推荐开通
   - 图像视觉质量修复
   - 图像属性增强
   - 图像曝光矫正
   - 图像色彩矫正
   - 图像裁剪
   - 图像超分辨率
   - 色彩迁移
   - 风格迁移
   - 用于：打光、阴影、图像增强、质量提升

3. **图像增强** - 可选
   - 图像去雾
   - 图像去噪
   - 图像超分辨率
   - 图像调色
   - 用于：图像质量提升（如果未开通图像生产，作为降级方案）

4. **其他功能**
   - 图像质量评估
   - 图像风格转换

## 二、开通服务

### 2.1 登录阿里云控制台

1. 访问 [阿里云控制台](https://home.console.aliyun.com/)
2. 登录您的阿里云账号

### 2.2 开通视觉智能开放平台

1. 进入 [视觉智能开放平台控制台](https://vision.console.aliyun.com/cn-shanghai/overview)
2. 在左侧菜单"开放能力"下找到需要开通的服务

### 2.3 必须开通的服务

**1. 分割抠图**（必须）
- 位置：开放能力 → 分割抠图
- 点击"立即开通"或右侧的"开"按钮
- 用于：抠图、背景替换功能

**2. 图像生产**（强烈推荐）
- 位置：开放能力 → 图像生产
- 点击"立即开通"
- 用于：打光、阴影、图像增强、质量提升
- 包含功能：图像裁剪、图像超分、色彩迁移、风格迁移等

### 2.4 可选服务

**图像增强**（可选）
- 如果未开通图像生产，可作为降级方案
- 位置：开放能力 → 图像增强（如果存在）

### 2.3 获取 AccessKey

**重要**：可以使用与 OSS 相同的 AccessKey，无需单独申请。

如果还没有 AccessKey：
1. 进入 [RAM 访问控制](https://ram.console.aliyun.com/manage/ak)
2. 创建 AccessKey（建议使用子账号）
3. 确保该 AccessKey 有视觉智能开放平台的访问权限

## 三、配置应用

### 3.1 更新 .env 文件

在项目根目录的 `.env` 文件中添加以下配置：

```env
# 阿里云视觉智能开放平台配置
# 可以使用与 OSS 相同的 AccessKey
VIAPI_ACCESS_KEY_ID=your_access_key_id
VIAPI_ACCESS_KEY_SECRET=your_access_key_secret
VIAPI_REGION=cn-shanghai
VIAPI_MOCK_MODE=false
```

### 3.2 配置说明

- **VIAPI_ACCESS_KEY_ID**: 阿里云 AccessKey ID（可与 OSS 共用）
- **VIAPI_ACCESS_KEY_SECRET**: 阿里云 AccessKey Secret（可与 OSS 共用）
- **VIAPI_REGION**: 服务区域，可选：
  - `cn-shanghai`（推荐，华东2）
  - `cn-beijing`（华北2）
  - `cn-hangzhou`（华东1）
  - `cn-shenzhen`（华南1）
- **VIAPI_MOCK_MODE**: 设置为 `false` 以使用真实服务

### 3.3 快速配置

如果已配置 OSS，可以直接复用：

```env
# 复用 OSS 的 AccessKey
VIAPI_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}
VIAPI_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}
VIAPI_REGION=cn-shanghai
VIAPI_MOCK_MODE=false
```

## 四、安装依赖

确保已安装必要的 Python 包：

```bash
pip install alibabacloud-imageseg20191230
pip install alibabacloud-imageenhan20190930
pip install alibabacloud-tea-openapi
pip install alibabacloud-tea-util
```

或使用 requirements.txt：

```bash
pip install -r requirements.txt
```

## 五、支持的操作

### 5.1 抠图（CUTOUT）

```python
operation = ImageOperation(
    type=OperationType.CUTOUT,
    params={}
)
```

**功能**：
- 自动识别图片主体
- 生成透明背景 PNG
- 支持人像、商品、场景等
- **使用服务**：图像分割（分割抠图）

### 5.2 背景处理（BACKGROUND）

```python
operation = ImageOperation(
    type=OperationType.BACKGROUND,
    params={
        "backgroundColor": "#FFFFFF",  # 背景颜色
        "backgroundTemplateId": "white"  # 背景模板
    }
)
```

**功能**：
- 替换背景为纯色
- 支持自定义背景颜色
- 基于抠图结果合成
- **使用服务**：图像分割（分割抠图）+ 本地合成

### 5.3 打光（LIGHTING）

```python
operation = ImageOperation(
    type=OperationType.LIGHTING,
    params={
        "brightness": 1.2,  # 亮度倍数（0.5-2.0）
        "contrast": 1.1     # 对比度倍数（0.5-2.0）
    }
)
```

**功能**：
- 调整图片亮度
- 调整图片对比度
- 优化光线效果
- 图像曝光矫正
- 图像色彩矫正
- **使用服务**：图像生产（优先）→ 图像增强（降级）→ 本地 PIL（最终降级）

### 5.4 滤镜（FILTER）

```python
operation = ImageOperation(
    type=OperationType.FILTER,
    params={
        "filterType": "blur"  # blur, sharpen, smooth
    }
)
```

**功能**：
- 应用模糊效果
- 应用锐化效果
- 应用平滑效果

### 5.5 调整大小（RESIZE）

```python
# 在 ProcessImageRequest 中设置
outputSize="2000x2000"
```

**功能**：
- 调整图片尺寸
- 保持宽高比（可选）
- 高质量缩放

## 六、价格参考

### 6.1 图像分割（分割抠图）

- **通用图像分割**：约 ¥0.01/次
- **人像分割**：约 ¥0.01/次
- **商品分割**：约 ¥0.01/次

### 6.2 图像生产

- **图像属性增强**：约 ¥0.02-0.05/次（根据功能不同）
- **图像视觉质量修复**：约 ¥0.03-0.08/次
- **图像超分辨率**：约 ¥0.05/次
- **色彩迁移**：约 ¥0.02/次
- **风格迁移**：约 ¥0.03/次

### 6.3 图像增强（降级方案）

- **图像去雾**：约 ¥0.02/次
- **图像去噪**：约 ¥0.02/次
- **图像超分辨率**：约 ¥0.05/次
- **图像调色**：约 ¥0.02/次

### 6.4 免费额度

新用户通常有免费额度，具体以官方为准。建议在控制台查看当前免费额度。

## 七、测试配置

### 7.1 重启应用

配置更新后，重启应用：

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 7.2 测试图片处理

使用 API 测试图片处理功能：

```bash
curl -X POST "http://localhost:8000/v1/images/process" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "imageId": "img_abc123",
    "operations": [
      {
        "type": "cutout",
        "params": {}
      },
      {
        "type": "background",
        "params": {
          "backgroundColor": "#FFFFFF"
        }
      }
    ],
    "outputSize": "2000x2000",
    "quality": 85
  }'
```

### 7.3 检查日志

查看应用日志，确认服务调用成功：

```bash
tail -f logs/app.log
```

应该看到类似以下日志：
```
INFO - Using Alibaba Cloud VIAPI for image processing
DEBUG - Image segmentation completed
INFO - Processed image uploaded to OSS
```

## 八、常见问题

### 8.1 AccessKey 权限不足

**问题**：返回权限错误

**解决方案**：
- 检查 AccessKey 是否有视觉智能开放平台的访问权限
- 在 RAM 控制台为 AccessKey 添加相应权限策略

### 8.2 服务调用失败

**问题**：API 调用返回错误

**解决方案**：
- 检查 `VIAPI_REGION` 配置是否正确
- 确认服务已开通
- 检查账户余额是否充足
- 查看详细错误日志

### 8.3 图片处理结果不理想

**问题**：抠图或处理效果不佳

**解决方案**：
- 确保原图质量良好
- 对于复杂场景，可能需要多次处理
- 可以结合通义千问 VL 的分析结果优化处理策略

### 8.4 SDK 导入错误

**问题**：`ModuleNotFoundError: No module named 'alibabacloud_imageseg20191230'`

**解决方案**：
```bash
pip install alibabacloud-imageseg20191230
pip install alibabacloud-imageenhan20190930
pip install alibabacloud-tea-openapi
pip install alibabacloud-tea-util
```

## 九、最佳实践

### 9.1 操作顺序

建议的处理顺序：
1. **抠图**（CUTOUT）- 提取主体
2. **背景处理**（BACKGROUND）- 替换背景
3. **打光**（LIGHTING）- 调整光线
4. **滤镜**（FILTER）- 应用效果
5. **调整大小**（RESIZE）- 最终尺寸

### 9.2 性能优化

1. **批量处理**：对于多张图片，考虑批量处理
2. **缓存结果**：对于相同操作，可以缓存处理结果
3. **异步处理**：使用后台任务处理，避免阻塞

### 9.3 错误处理

1. **降级策略**：如果 VIAPI 失败，可以降级到本地处理
2. **重试机制**：对于临时错误，实现重试逻辑
3. **日志记录**：详细记录处理过程，便于排查问题

## 十、配置检查清单

- [ ] 已开通视觉智能开放平台服务
- [ ] 已获取 AccessKey（可与 OSS 共用）
- [ ] 已更新 `.env` 文件配置
- [ ] `VIAPI_ACCESS_KEY_ID` 已配置
- [ ] `VIAPI_ACCESS_KEY_SECRET` 已配置
- [ ] `VIAPI_REGION` 已设置
- [ ] `VIAPI_MOCK_MODE` 设置为 `false`
- [ ] 已安装必要的 Python 包
- [ ] 已重启应用
- [ ] 已测试图片处理功能
- [ ] 已检查日志确认调用成功

## 十一、参考链接

- [视觉智能开放平台控制台](https://vision.aliyun.com/)
- [图像分割 API 文档](https://help.aliyun.com/document_detail/175875.html)
- [图像增强 API 文档](https://help.aliyun.com/document_detail/151960.html)
- [价格说明](https://help.aliyun.com/document_detail/154004.html)

