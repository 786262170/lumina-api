# Lumina 域名配置指南

本文档说明如何注册 `lumina` 域名并配置二级域名（API 和静态资源）。

## 一、域名注册

### 1.1 选择域名注册商

推荐使用以下服务商：
- **阿里云** (https://wanwang.aliyun.com/)
- **腾讯云** (https://dnspod.cloud.tencent.com/)
- **GoDaddy** (https://www.godaddy.com/)
- **Namecheap** (https://www.namecheap.com/)

### 1.2 注册域名

1. 访问域名注册商网站
2. 搜索 `lumina.ai` 或 `lumina.com` 等域名
3. 选择合适的域名后缀（推荐：`.ai`, `.com`, `.io`）
4. 完成购买和实名认证（国内服务商需要）

## 二、DNS 配置

### 2.1 获取服务器 IP 地址

假设您的服务器 IP 地址为：`1.2.3.4`（请替换为实际 IP）

### 2.2 配置二级域名

在域名管理后台添加以下 DNS 记录：

#### 方案一：使用 A 记录（推荐）

```
类型    主机记录    记录值           TTL
A       api       1.2.3.4         600
A       static    1.2.3.4         600
```

**说明：**
- `api.lumina.ai` → 指向 API 服务器
- `static.lumina.ai` → 指向静态资源服务器（可以与 API 同一服务器）

#### 方案二：使用 CNAME（如果使用 CDN）

```
类型    主机记录    记录值                    TTL
CNAME   api       api.example.com          600
CNAME   static    static.example.com       600
```

### 2.3 配置示例（阿里云 DNS）

1. 登录阿里云控制台
2. 进入 **云解析 DNS** → **域名解析**
3. 选择 `lumina.ai` 域名
4. 点击 **添加记录**，配置如下：

**API 域名：**
- 记录类型：`A`
- 主机记录：`api`
- 记录值：`1.2.3.4`（您的服务器 IP）
- TTL：`600`（10分钟）

**静态资源域名：**
- 记录类型：`A`
- 主机记录：`static`
- 记录值：`1.2.3.4`（您的服务器 IP，或 CDN 地址）
- TTL：`600`

### 2.4 配置示例（腾讯云 DNS）

1. 登录腾讯云控制台
2. 进入 **DNS 解析 DNSPod** → **我的域名**
3. 选择 `lumina.ai` 域名
4. 点击 **添加记录**，配置同上

## 三、SSL 证书配置

### 3.1 申请免费 SSL 证书

推荐使用：
- **Let's Encrypt** (免费，自动续期)
- **阿里云 SSL 证书** (免费 DV 证书)
- **腾讯云 SSL 证书** (免费 DV 证书)

### 3.2 使用 Let's Encrypt (Certbot)

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书（Nginx）
sudo certbot --nginx -d api.lumina.ai -d static.lumina.ai

# 或使用 Standalone 模式
sudo certbot certonly --standalone -d api.lumina.ai -d static.lumina.ai
```

### 3.3 配置 Nginx 反向代理

创建 `/etc/nginx/sites-available/lumina`：

```nginx
# API 服务器配置
server {
    listen 80;
    server_name api.lumina.ai;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.lumina.ai;
    
    ssl_certificate /etc/letsencrypt/live/api.lumina.ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.lumina.ai/privkey.pem;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 静态资源服务器配置
server {
    listen 80;
    server_name static.lumina.ai;
    
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name static.lumina.ai;
    
    ssl_certificate /etc/letsencrypt/live/static.lumina.ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/static.lumina.ai/privkey.pem;
    
    # 静态文件目录
    root /path/to/lumina-api/uploads;
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # 缓存配置
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/lumina /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 四、应用配置

### 4.1 更新 .env 文件

在 `.env` 文件中添加域名配置：

```env
# Domain Configuration
API_DOMAIN=api.lumina.ai
STATIC_DOMAIN=static.lumina.ai

# Base URL (用于本地开发，生产环境会被域名覆盖)
BASE_URL=https://api.lumina.ai
```

### 4.2 验证配置

1. **检查 DNS 解析：**
   ```bash
   nslookup api.lumina.ai
   nslookup static.lumina.ai
   ```

2. **检查 SSL 证书：**
   ```bash
   curl -I https://api.lumina.ai/health
   curl -I https://static.lumina.ai/
   ```

3. **测试 API：**
   ```bash
   curl https://api.lumina.ai/health
   ```

## 五、CDN 配置（可选）

### 5.1 使用阿里云 CDN

1. 登录阿里云控制台
2. 进入 **CDN** → **域名管理**
3. 添加加速域名：`static.lumina.ai`
4. 配置源站：`api.lumina.ai` 或服务器 IP
5. 配置缓存规则和 HTTPS

### 5.2 使用腾讯云 CDN

1. 登录腾讯云控制台
2. 进入 **CDN** → **域名管理**
3. 添加域名：`static.lumina.ai`
4. 配置源站和缓存规则

## 六、常见问题

### 6.1 DNS 解析不生效

- 等待 DNS 传播（通常 10 分钟到 24 小时）
- 清除本地 DNS 缓存：`sudo dscacheutil -flushcache` (macOS)
- 使用 `dig` 或 `nslookup` 检查解析结果

### 6.2 SSL 证书申请失败

- 确保域名已正确解析到服务器
- 确保 80/443 端口已开放
- 检查防火墙设置

### 6.3 静态资源无法访问

- 检查 Nginx 配置中的 `root` 路径是否正确
- 检查文件权限：`chmod -R 755 /path/to/uploads`
- 检查 Nginx 日志：`tail -f /var/log/nginx/error.log`

## 七、生产环境检查清单

- [ ] 域名已注册并实名认证
- [ ] DNS 记录已配置（A 记录或 CNAME）
- [ ] SSL 证书已申请并配置
- [ ] Nginx 反向代理已配置
- [ ] 防火墙规则已开放（80, 443 端口）
- [ ] `.env` 文件中的域名配置已更新
- [ ] 应用已重启并加载新配置
- [ ] DNS 解析已生效（使用 `nslookup` 验证）
- [ ] HTTPS 访问正常（使用 `curl` 测试）
- [ ] API 接口可正常访问
- [ ] 静态资源可正常访问

## 八、参考链接

- [阿里云域名注册](https://wanwang.aliyun.com/)
- [腾讯云域名注册](https://dnspod.cloud.tencent.com/)
- [Let's Encrypt 文档](https://letsencrypt.org/docs/)
- [Nginx 反向代理配置](https://nginx.org/en/docs/http/ngx_http_proxy_module.html)

